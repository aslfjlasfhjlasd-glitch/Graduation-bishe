# 活动大厅学分筛选功能实现说明

## 🎯 功能概述
在志愿活动大厅页面添加"按学分筛选"功能，允许学生根据活动学分快速筛选感兴趣的活动。

## 📋 实现方式
采用**前端筛选**方式，与现有的"状态筛选"、"地点筛选"保持一致，无需修改后端接口。

## ✅ 修改内容

### 1. 新增状态变量和选项

**文件**: `frontend/src/views/student/components/ActivityHall.vue`

**位置**: 第 13-20 行

```javascript
// 搜索和筛选相关状态
const searchKeyword = ref('')
const selectedStatus = ref('全部')
const selectedLocation = ref('全部')
const selectedCredit = ref('全部') // 🔥 新增：学分筛选状态
const showFilters = ref(false)

// 🔥 新增：定义学分选项
const creditOptions = ['全部', '0.5分', '1.0分', '1.5分', '2.0分及以上']
```

### 2. 数据加载时获取学分字段

**位置**: `loadActivities` 函数，第 55-71 行

```javascript
activities.value = rows.map(r => ({
  id: Number(r.hdBh || r.hdbh || r.HD_BH || r.id),
  hdmc: String(r.hdmc || r.hdMc || r.HD_MC || ''),
  // ... 其他字段 ...
  // 🔥 新增：学分字段
  hdxf: parseFloat(r.hdxf || r.hdXf || r.HD_XF || 0),
  icon: pickIcon(r.hdmc)
}))
```

### 3. 添加学分筛选逻辑

**位置**: `filteredActivities` 计算属性，第 398-420 行

```javascript
// 地点筛选
if (selectedLocation.value !== '全部') {
  result = result.filter(a => a.hddd === selectedLocation.value)
}

// 🔥 新增：学分筛选
if (selectedCredit.value !== '全部') {
  result = result.filter(a => {
    // 兼容字段名大小写，并转为浮点数，默认0
    const credit = parseFloat(a.hdxf || a.hdXf || 0)
    
    if (selectedCredit.value === '2.0分及以上') {
      return credit >= 2.0
    } else {
      // 提取选项中的数字部分进行比较 (例如 "0.5分" -> 0.5)
      const target = parseFloat(selectedCredit.value)
      // 使用极小的误差范围比较浮点数
      return Math.abs(credit - target) < 0.01
    }
  })
}
```

### 4. 更新清空逻辑

**位置**: `clearSearch` 函数，第 429-434 行

```javascript
const clearSearch = () => {
  searchKeyword.value = ''
  selectedStatus.value = '全部'
  selectedLocation.value = '全部'
  selectedCredit.value = '全部' // 🔥 新增：重置学分筛选
}
```

### 5. 添加学分筛选UI

**位置**: 筛选面板，第 710-760 行

```vue
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <!-- 状态筛选 -->
  <div>...</div>

  <!-- 地点筛选 -->
  <div>...</div>

  <!-- 🔥 新增：学分筛选 -->
  <div>
    <label class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
      <Star class="w-4 h-4 text-amber-500" />
      活动学分
    </label>
    <select
      v-model="selectedCredit"
      class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-900 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 transition-all duration-200"
    >
      <option v-for="opt in creditOptions" :key="opt" :value="opt">
        {{ opt }}
      </option>
    </select>
  </div>
</div>
```

### 6. 更新清空按钮和统计显示

**清空按钮条件** (第 695-703 行):
```vue
<Button
  v-if="searchKeyword || selectedStatus !== '全部' || selectedLocation !== '全部' || selectedCredit !== '全部'"
  @click="clearSearch"
  ...
>
```

**搜索结果统计** (第 752-756 行):
```vue
<div v-if="searchKeyword || selectedStatus !== '全部' || selectedLocation !== '全部' || selectedCredit !== '全部'" ...>
  <span>找到 <span class="font-semibold text-blue-600">{{ filteredActivities.length }}</span> 个活动</span>
</div>
```

## 🎨 UI 设计特点

### 学分筛选器样式
- **图标**: 使用 `Star` 图标（琥珀色）
- **位置**: 筛选面板第三列
- **样式**: 下拉选择框，与地点筛选保持一致
- **焦点效果**: 琥珀色边框和阴影

### 布局调整
- 筛选面板从 2 列改为 3 列布局
- 响应式设计：移动端单列，桌面端三列
- 网格类名：`grid-cols-1 md:grid-cols-3`

## 🔍 筛选逻辑说明

### 学分选项
```javascript
['全部', '0.5分', '1.0分', '1.5分', '2.0分及以上']
```

### 筛选规则

1. **全部**: 不进行筛选，显示所有活动

2. **精确匹配** (0.5分、1.0分、1.5分):
   ```javascript
   const target = parseFloat(selectedCredit.value) // 提取数字
   return Math.abs(credit - target) < 0.01 // 浮点数比较
   ```

3. **范围匹配** (2.0分及以上):
   ```javascript
   return credit >= 2.0
   ```

### 浮点数比较
使用误差范围 `0.01` 来比较浮点数，避免精度问题：
```javascript
Math.abs(credit - target) < 0.01
```

## 📊 数据字段说明

### 后端字段
- 字段名: `HD_XF` (数据库) → `hdxf` 或 `hdXf` (后端返回)
- 数据类型: `DECIMAL` 或 `FLOAT`
- 示例值: `0.5`, `1.0`, `1.5`, `2.0`

### 前端处理
```javascript
// 兼容多种字段名格式
hdxf: parseFloat(r.hdxf || r.hdXf || r.HD_XF || 0)
```

## 🧪 测试场景

### 场景 1: 筛选 0.5 分活动
1. 点击"筛选"按钮
2. 在"活动学分"下拉框选择"0.5分"
3. 验证只显示学分为 0.5 的活动

### 场景 2: 筛选 2.0 分及以上活动
1. 选择"2.0分及以上"
2. 验证显示学分 ≥ 2.0 的所有活动

### 场景 3: 组合筛选
1. 选择状态："活动报名中"
2. 选择地点："图书馆"
3. 选择学分："1.0分"
4. 验证同时满足三个条件的活动

### 场景 4: 清空筛选
1. 设置多个筛选条件
2. 点击"清空"按钮
3. 验证所有筛选条件重置为"全部"

### 场景 5: 无结果情况
1. 选择一个不存在的学分组合
2. 验证显示"未找到相关活动"提示

## 🔧 后端数据确认

### 检查 SQL 查询
确保 `DashboardMapper.xml` 中的查询包含学分字段：

```xml
<select id="listActivities" resultType="...">
  SELECT 
    HD_BH as hdBh,
    HD_MC as hdMc,
    HD_XF as hdXf,  <!-- 🔥 确保包含此字段 -->
    ...
  FROM t_hd
</select>
```

### 验证数据
```sql
-- 查看活动学分分布
SELECT HD_XF, COUNT(*) as count
FROM t_hd
GROUP BY HD_XF
ORDER BY HD_XF;
```

## 💡 优势说明

### 1. 前端筛选优势
- ✅ 无需修改后端接口
- ✅ 响应速度快（毫秒级）
- ✅ 减少服务器压力
- ✅ 用户体验好（即时反馈）

### 2. 与现有功能一致
- ✅ 使用相同的筛选管道
- ✅ 样式风格统一
- ✅ 交互逻辑一致
- ✅ 易于维护

### 3. 扩展性好
- ✅ 可轻松添加更多学分选项
- ✅ 可调整筛选规则
- ✅ 可与其他筛选条件组合

## 📝 注意事项

### 1. 数据类型处理
```javascript
// 确保转换为数字类型
const credit = parseFloat(a.hdxf || a.hdXf || 0)
```

### 2. 字段名兼容
```javascript
// 兼容多种命名格式
r.hdxf || r.hdXf || r.HD_XF || 0
```

### 3. 浮点数比较
```javascript
// 使用误差范围，不要直接用 ===
Math.abs(credit - target) < 0.01
```

### 4. 默认值处理
```javascript
// 如果没有学分数据，默认为 0
parseFloat(r.hdxf || 0)
```

## 🚀 使用方法

### 用户操作流程
```
1. 进入志愿活动大厅
   ↓
2. 点击"筛选"按钮
   ↓
3. 在"活动学分"下拉框选择学分
   ↓
4. 查看筛选结果
   ↓
5. 可继续添加其他筛选条件
   ↓
6. 点击"清空"重置所有筛选
```

### 快捷操作
- 直接在下拉框选择学分，无需点击确认
- 选择后立即生效，实时更新列表
- 可随时切换不同学分选项

## 📊 筛选效果示例

### 示例 1: 筛选 1.0 分活动
```
原始活动数: 50
筛选后: 15 个活动
显示: "找到 15 个活动"
```

### 示例 2: 组合筛选
```
条件:
- 状态: 活动报名中
- 地点: 图书馆
- 学分: 1.5分

结果: 找到 3 个活动
```

## ✅ 完成清单

- [x] 添加学分筛选状态变量
- [x] 定义学分选项数组
- [x] 数据加载时获取学分字段
- [x] 实现学分筛选逻辑
- [x] 更新清空逻辑
- [x] 添加学分筛选UI
- [x] 更新清空按钮条件
- [x] 更新搜索结果统计
- [x] 调整筛选面板布局（2列→3列）

## 🎉 功能特点

1. **即时筛选**: 选择后立即生效
2. **组合筛选**: 可与状态、地点组合使用
3. **清晰反馈**: 显示筛选结果数量
4. **易于使用**: 下拉选择，操作简单
5. **视觉统一**: 与现有筛选器风格一致

---

**实现时间**: 2025-12-15  
**实现方式**: 前端筛选  
**状态**: ✅ 已完成并可测试