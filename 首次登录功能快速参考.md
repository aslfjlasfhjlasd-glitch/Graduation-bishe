# 首次登录强制修改密码功能 - 快速参考

## 🎯 功能概述
学生使用默认密码（123456）首次登录时，系统会强制跳转到设置页面，要求修改密码并可选择完善兴趣/技能标签。

## 📁 涉及文件

### 前端文件
```
frontend/src/views/student/FirstLoginSetup.vue    ← 新增：首次登录设置页面
frontend/src/router/index.js                       ← 修改：添加路由和守卫
frontend/src/views/Login.vue                       ← 修改：添加首次登录判断
```

### 后端文件
```
backend/src/main/java/com/university/volunteer/controller/StudentController.java  ← 修改：增强接口
backend/src/main/java/com/university/volunteer/service/StudentService.java        ← 修改：新增方法
```

## 🔑 关键代码片段

### 1. 登录判断逻辑 (Login.vue)
```javascript
if (password.value === '123456') {
  localStorage.setItem('isFirstLogin', 'true');
  router.push('/first-login');
} else {
  router.push('/student/dashboard');
}
```

### 2. 路由配置 (router/index.js)
```javascript
{
  path: '/first-login',
  name: 'FirstLoginSetup',
  component: () => import('../views/student/FirstLoginSetup.vue'),
  meta: { requiresAuth: true, role: 'student' }
}
```

### 3. 密码修改API调用
```javascript
await axios.put('http://localhost:8080/api/student/password', {
  studentIdFromStorage: studentId,
  oldPassword: '123456',
  newPassword: passwordForm.value.newPassword
})
```

### 4. 标签更新API调用
```javascript
await axios.post('http://localhost:8080/api/student/tags', {
  studentIdFromStorage: studentId,
  tagIds: allSelectedTags
})
```

## 🔄 完整流程

```
用户登录(密码=123456)
    ↓
Login.vue 检测默认密码
    ↓
跳转 /first-login
    ↓
FirstLoginSetup.vue 加载
    ├─ 获取个人信息
    ├─ 加载标签列表
    └─ 等待用户操作
    ↓
用户填写新密码 + 选择标签
    ↓
点击"完成设置"
    ↓
前端校验密码
    ↓
调用密码修改API
    ↓
调用标签更新API
    ↓
清除 isFirstLogin 标记
    ↓
跳转 /student/dashboard
```

## ✅ 密码校验规则

1. ❌ 不能为空
2. ❌ 不能为 `123456`
3. ❌ 长度不能少于 6 位
4. ❌ 两次输入必须一致

## 🏷️ 标签功能

- **兴趣标签**: 蓝色主题，类型=1
- **技能标签**: 绿色主题，类型=2
- **选择方式**: 点击切换选中状态
- **是否必填**: 否（推荐选择）

## 🔌 后端API接口

### 1. 获取个人信息
```
GET /api/student/profile?studentId={学号}
```

### 2. 修改密码
```
PUT /api/student/password
Body: {
  studentIdFromStorage: "学号",
  oldPassword: "旧密码",
  newPassword: "新密码"
}
```

### 3. 更新标签
```
POST /api/student/tags
Body: {
  studentIdFromStorage: "学号",
  tagIds: [1, 2, 3]
}
```

### 4. 获取标签列表
```
GET /api/tags
```

## 🗄️ 数据库操作

### 密码修改
```sql
UPDATE t_xs SET xs_mm = '新密码' WHERE xs_xh = 学号;
```

### 标签关联
```sql
-- 删除旧标签
DELETE FROM t_xs_bq WHERE xs_xh = 学号;

-- 插入新标签
INSERT INTO t_xs_bq (xs_xh, bq_id) VALUES (学号, 标签ID);

-- 更新冗余字段
UPDATE t_xs SET xq_bq = '兴趣标签', jn_bq = '技能标签' WHERE xs_xh = 学号;
```

## 🐛 常见问题

### Q1: 修改密码后仍跳转到设置页面？
**A**: 检查是否清除了 `isFirstLogin` 标记，确保使用新密码登录。

### Q2: 个人信息不显示？
**A**: 检查 localStorage 中是否有 `studentId`，查看浏览器控制台错误。

### Q3: 标签列表为空？
**A**: 确认数据库 `t_bq` 表中有标签数据。

### Q4: 提交后报错？
**A**: 查看浏览器 Network 标签，检查 API 请求和响应。

### Q5: 路由守卫不生效？
**A**: 确认 localStorage 中有 `token` 和 `role` 字段。

## 🧪 快速测试

### 测试步骤
1. 使用学号和密码 `123456` 登录
2. 验证跳转到 `/first-login`
3. 输入新密码（如 `newpass123`）
4. 选择几个标签
5. 点击"完成设置"
6. 验证跳转到学生首页
7. 退出登录，使用新密码重新登录
8. 验证直接进入学生首页

### 验证数据
```sql
-- 查看密码是否更新
SELECT xs_xh, xs_xm, xs_mm FROM t_xs WHERE xs_xh = '你的学号';

-- 查看标签是否保存
SELECT * FROM t_xs_bq WHERE xs_xh = '你的学号';
```

## 📊 LocalStorage 数据

### 登录后存储
```javascript
{
  token: "登录令牌",
  studentId: "学号",
  studentName: "姓名",
  role: "student",
  userRole: "student",
  isFirstLogin: "true"  // 仅首次登录时
}
```

### 设置完成后
```javascript
{
  token: "登录令牌",
  studentId: "学号",
  studentName: "姓名",
  role: "student",
  userRole: "student"
  // isFirstLogin 已删除
}
```

## 🎨 UI 特点

- **渐变背景**: 蓝色到靛蓝色渐变
- **卡片布局**: 白色卡片，阴影效果
- **颜色区分**: 
  - 个人信息区：蓝色 (bg-blue-50)
  - 密码修改区：琥珀色 (bg-amber-50)
  - 标签选择区：绿色 (bg-green-50)
- **响应式**: 支持移动端和桌面端

## 📝 注意事项

1. **密码存储**: 当前为明文存储，生产环境需加密
2. **Token管理**: 建议实现JWT token机制
3. **错误处理**: 所有API调用都有try-catch保护
4. **事务处理**: 后端使用 @Transactional 保证数据一致性
5. **路由守卫**: 防止未登录或非学生角色访问

## 🚀 启动命令

### 后端
```bash
cd backend
mvn spring-boot:run
```

### 前端
```bash
cd frontend
npm run dev
```

### 访问地址
- 前端: http://localhost:5173
- 后端: http://localhost:8080

## 📚 相关文档

- `首次登录强制修改密码功能实现总结.md` - 详细实现说明
- `首次登录功能测试指南.md` - 完整测试用例

---

**开发完成时间**: 2025-12-14  
**版本**: v1.0  
**状态**: ✅ 已完成并可测试