# 智能推荐算法优化 - 热门活动阈值实现总结

## 📋 任务概述

优化智能推荐算法，实现"活动点击量（查看详情按钮被点击的次数）达到学生总数 10% 以上才算热门活动"的逻辑。

## 🎯 实现目标

- **冷启动保护**：新发布的活动如果浏览量未达到学生总数的 10%，不会被作为"热门活动"推荐
- **真实热度**：只有真正受关注（浏览量高）的活动才会进入热门推荐列表
- **动态阈值**：阈值随学生总数动态调整，适应不同规模的系统

## 🔧 修改内容

### 1. StudentMapper.java（新增统计方法）

**文件路径**：`backend/src/main/java/com/university/volunteer/mapper/StudentMapper.java`

**新增方法**：
```java
/**
 * 统计学生总数
 */
int countAllStudents();
```

**说明**：用于获取系统中的学生总数，作为计算热门活动阈值的基础。

---

### 2. StudentMapper.xml（实现统计查询）

**文件路径**：`backend/src/main/resources/mapper/StudentMapper.xml`

**新增 SQL**：
```xml
<!-- 统计学生总数 -->
<select id="countAllStudents" resultType="java.lang.Integer">
    SELECT COUNT(*) FROM t_xs
</select>
```

**说明**：从学生表 `t_xs` 中统计总人数。

---

### 3. StudentActivityMapper.java（新增带阈值的查询方法）

**文件路径**：`backend/src/main/java/com/university/volunteer/mapper/StudentActivityMapper.java`

**新增方法**：
```java
/**
 * 获取热门活动（带浏览量阈值）
 * @param limit 限制数量
 * @param minViews 最低浏览次数
 */
List<VolunteerActivity> findHotActivitiesWithThreshold(@Param("limit") int limit, @Param("minViews") int minViews);
```

**说明**：在原有热门活动查询基础上，增加浏览量下限参数。

---

### 4. StudentActivityMapper.xml（实现带阈值的热门查询）

**文件路径**：`backend/src/main/resources/mapper/StudentActivityMapper.xml`

**新增 SQL**：
```xml
<!-- 获取热门活动（带浏览量阈值） -->
<select id="findHotActivitiesWithThreshold" resultMap="VolunteerActivityResultMap">
    SELECT HD_BH, HD_MC,
           CONCAT(DATE_FORMAT(BM_KSSJ, '%Y-%m-%d %H:%i'), '至', DATE_FORMAT(BM_JSSJ, '%Y-%m-%d %H:%i')) as bmSj,
           CONCAT(DATE_FORMAT(HD_KSSJ, '%Y-%m-%d %H:%i'), '-', DATE_FORMAT(HD_JSSJ, '%Y-%m-%d %H:%i')) as hdSj,
           BM_KSSJ, BM_JSSJ, HD_KSSJ, HD_JSSJ,
           HD_NR, HD_DD, ZM_RS, YBM_RS, HDXQ,
           HD_BZ, HD_FQ_DW, HD_ZT, FB_ZT,
           HD_BQ, JN_YQ, ZY_XZ, BBH, LL_CS
    FROM t_zyhd
    WHERE FB_ZT = '已发布'
      AND BM_JSSJ > NOW()
      AND LL_CS >= #{minViews}
    ORDER BY YBM_RS DESC, HD_BH DESC
    LIMIT #{limit}
</select>
```

**关键变化**：
- 新增条件：`AND LL_CS >= #{minViews}` - 只查询浏览次数达到阈值的活动

---

### 5. StudentActivityService.java（集成阈值计算逻辑）

**文件路径**：`backend/src/main/java/com/university/volunteer/service/StudentActivityService.java`

**修改位置**：`getRecommendedActivities()` 方法中的兜底策略部分

**核心逻辑**：
```java
// 4. 兜底策略：如果推荐结果少于5个，补充热门活动
if (recommendList.size() < 5) {
    // 步骤A：获取学生总数
    int totalStudents = 0;
    try {
        totalStudents = studentMapper.countAllStudents();
    } catch (Exception e) {
        // 防止统计失败影响推荐，给个默认值或打日志
        e.printStackTrace();
    }

    // 步骤B：计算阈值 (10%)
    // 如果是新系统学生很少，至少要求1次浏览
    int minViewsThreshold = Math.max(1, (int) Math.ceil(totalStudents * 0.1));
    
    // 步骤C：查询符合条件的热门活动
    List<VolunteerActivity> hotActivities = studentActivityMapper.findHotActivitiesWithThreshold(10, minViewsThreshold);
    
    // ... 后续去重和添加到推荐列表的逻辑
}
```

**关键改进**：
1. **动态阈值计算**：`minViewsThreshold = Math.max(1, Math.ceil(totalStudents * 0.1))`
   - 学生总数 1000 人 → 阈值 100 次浏览
   - 学生总数 50 人 → 阈值 5 次浏览
   - 学生总数 5 人 → 阈值 1 次浏览（最小值保护）

2. **异常处理**：统计失败不影响推荐功能，系统会继续运行

3. **空值保护**：增加 `if (hotActivities != null)` 判断

---

## 📊 预期效果

### 场景 1：大型系统（1000+ 学生）
- **阈值**：100 次浏览
- **效果**：只有真正热门的活动（被至少 100 人查看）才会进入推荐
- **优势**：过滤掉冷门活动，提升推荐质量

### 场景 2：中型系统（100-500 学生）
- **阈值**：10-50 次浏览
- **效果**：适中的门槛，既保证热度又不会过于严格

### 场景 3：小型系统/测试环境（<10 学生）
- **阈值**：1 次浏览（最小值）
- **效果**：保证系统可用性，不会因为学生少而没有推荐

### 场景 4：新发布活动
- **现象**：浏览量只有几次，即使报名人数多
- **结果**：不会被推荐为"热门活动"
- **意义**：避免"刷报名"但实际关注度低的活动霸榜

---

## 🧪 测试建议

### 1. 功能测试
```sql
-- 查看当前学生总数
SELECT COUNT(*) FROM t_xs;

-- 查看活动浏览量分布
SELECT HD_BH, HD_MC, LL_CS, YBM_RS 
FROM t_zyhd 
WHERE FB_ZT = '已发布' 
ORDER BY LL_CS DESC;

-- 模拟阈值查询（假设学生总数 100，阈值 10）
SELECT HD_BH, HD_MC, LL_CS, YBM_RS 
FROM t_zyhd 
WHERE FB_ZT = '已发布' 
  AND BM_JSSJ > NOW() 
  AND LL_CS >= 10
ORDER BY YBM_RS DESC;
```

### 2. 边界测试
- **学生数为 0**：阈值应为 1（最小值保护）
- **学生数为 1**：阈值应为 1
- **学生数为 10**：阈值应为 1
- **学生数为 100**：阈值应为 10
- **学生数为 1000**：阈值应为 100

### 3. 推荐效果测试
1. 登录学生账号
2. 访问"智能推荐"页面
3. 观察推荐列表中的"热门活动"
4. 验证这些活动的浏览量是否都 >= 阈值

---

## 📝 代码审查要点

### ✅ 已实现
- [x] 学生总数统计方法
- [x] 带阈值的热门活动查询
- [x] 动态阈值计算（10%）
- [x] 最小值保护（至少 1 次）
- [x] 异常处理（统计失败不影响推荐）
- [x] 空值保护（查询结果为空的处理）

### ⚠️ 注意事项
1. **性能考虑**：`COUNT(*)` 查询在学生表很大时可能较慢，建议：
   - 添加缓存（Redis）
   - 定时任务更新（每小时）
   - 使用数据库统计表

2. **阈值调整**：当前为 10%，可根据实际情况调整：
   ```java
   // 修改这里的 0.1 即可调整百分比
   int minViewsThreshold = Math.max(1, (int) Math.ceil(totalStudents * 0.1));
   ```

3. **数据一致性**：确保 `LL_CS` 字段被正确更新（已在之前的升级中实现）

---

## 🚀 部署步骤

1. **备份数据库**（重要！）
   ```bash
   mysqldump -u root -p universityta > backup_before_threshold.sql
   ```

2. **停止后端服务**
   ```bash
   ./stop.bat
   ```

3. **编译项目**
   ```bash
   cd backend
   mvn clean package -DskipTests
   ```

4. **启动服务**
   ```bash
   cd ..
   ./start.bat
   ```

5. **验证功能**
   - 访问学生端推荐页面
   - 检查后端日志是否有错误
   - 验证推荐结果是否符合预期

---

## 📚 相关文档

- [智能推荐算法升级-浏览次数功能实现总结.md](./智能推荐算法升级-浏览次数功能实现总结.md)
- [智能推荐算法升级-浏览次数功能完成报告.md](./智能推荐算法升级-浏览次数功能完成报告.md)
- [database_upgrade_view_count.sql](./database_upgrade_view_count.sql)

---

## ✨ 总结

本次优化通过引入**动态阈值机制**，成功实现了"浏览量达到学生总数 10% 才算热门"的业务逻辑。这不仅提升了推荐系统的准确性，还有效防止了低质量活动通过刷报名数进入推荐列表。

**核心价值**：
- 🎯 **精准推荐**：只推荐真正受关注的活动
- 🛡️ **冷启动保护**：新活动需要积累足够浏览量才能成为热门
- 📈 **动态适应**：阈值随学生规模自动调整
- 🔒 **稳定可靠**：完善的异常处理和边界保护

---

## 🎨 前端优化：查看更多推荐功能

### 修改文件
**文件路径**：`frontend/src/views/student/components/ActivityHall.vue`

### 实现内容

#### 1. 新增状态变量（第 42 行）
```javascript
const showAllRecommendations = ref(false) // 控制是否展开所有推荐
```

#### 2. 修改 v-for 循环逻辑（第 440 行）
```vue
<Card
  v-for="item in (showAllRecommendations ? recommendedActivities : recommendedActivities.slice(0, 6))"
  :key="item.id"
  ...
>
```

**逻辑说明**：
- 当 `showAllRecommendations` 为 `false` 时，只显示前 6 个推荐活动
- 当 `showAllRecommendations` 为 `true` 时，显示所有推荐活动

#### 3. 添加展开/收起按钮（第 547-560 行）

**展开按钮**（当有超过 6 个推荐且未展开时显示）：
```vue
<div v-if="recommendedActivities.length > 6 && !showAllRecommendations" class="mt-4 text-center">
  <Button
    variant="outline"
    class="gap-2"
    @click="showAllRecommendations = true"
  >
    <Sparkles class="w-4 h-4" />
    查看更多推荐 ({{ recommendedActivities.length - 6 }}+)
  </Button>
</div>
```

**收起按钮**（当已展开时显示）：
```vue
<div v-if="showAllRecommendations && recommendedActivities.length > 6" class="mt-4 text-center">
  <Button
    variant="ghost"
    class="gap-2 text-slate-500"
    @click="showAllRecommendations = false"
  >
    收起推荐
  </Button>
</div>
```

### 用户体验优化

✅ **默认折叠**：初始只显示 6 个推荐活动，避免页面过长
✅ **动态提示**：按钮显示剩余推荐数量（如 "+4"）
✅ **平滑切换**：点击按钮即可展开/收起，无需刷新页面
✅ **智能显示**：只有推荐数量 > 6 时才显示按钮
✅ **视觉反馈**：展开后显示"收起推荐"按钮，方便用户返回

---

**修改时间**：2025-12-13
**修改人**：AI Assistant
**版本**：v1.1（新增前端优化）