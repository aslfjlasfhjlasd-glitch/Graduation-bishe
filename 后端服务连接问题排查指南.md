# 后端服务连接问题排查指南

## 🔴 问题现象
登录时提示"登录失败: 服务器无法连接"

## 🔍 可能原因

### 1. 后端服务未启动或已停止
修改数据库后，后端服务可能需要重启，或者服务已经崩溃。

### 2. 数据库连接问题
修改数据库后，可能导致数据库连接失败或配置不匹配。

### 3. 端口被占用
8080端口可能被其他程序占用。

## 📋 排查步骤

### 步骤1: 检查后端服务是否运行

**Windows系统**:
```cmd
# 检查8080端口是否被占用
netstat -ano | findstr :8080

# 如果有输出，说明端口被占用
# 记下最后一列的PID（进程ID）

# 查看是什么进程占用了端口
tasklist | findstr <PID>
```

**预期结果**:
- 如果看到 `java.exe`，说明后端服务正在运行
- 如果没有任何输出，说明后端服务未启动

### 步骤2: 查看后端服务日志

1. 找到运行后端服务的终端窗口
2. 查看最后的日志输出
3. 寻找以下关键信息：

**正常启动的标志**:
```
Started VolunteerApplication in X.XXX seconds
Tomcat started on port(s): 8080
```

**常见错误**:
```
# 数据库连接失败
Communications link failure
Access denied for user

# 端口被占用
Port 8080 is already in use

# SQL语法错误
SQLSyntaxErrorException

# 字段不存在
Unknown column 'XXX' in 'field list'
```

### 步骤3: 检查数据库连接配置

**文件**: `backend/src/main/resources/application.properties`

**检查项**:
```properties
# 数据库URL是否正确
spring.datasource.url=jdbc:mysql://localhost:3306/universityta?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true

# 用户名密码是否正确
spring.datasource.username=root
spring.datasource.password=你的密码

# 数据库名称是否正确
# 确认数据库 universityta 存在
```

### 步骤4: 测试数据库连接

**使用MySQL命令行**:
```cmd
mysql -u root -p
# 输入密码后

# 查看所有数据库
SHOW DATABASES;

# 切换到项目数据库
USE universityta;

# 查看所有表
SHOW TABLES;

# 检查关键表是否存在
DESC t_xs;
DESC t_zyhd;
DESC t_admin;
```

### 步骤5: 重启后端服务

**方法1: 使用Maven命令**
```cmd
# 进入backend目录
cd backend

# 清理并重新编译
mvn clean compile

# 启动服务
mvn spring-boot:run
```

**方法2: 使用start.bat（如果有）**
```cmd
# 先停止旧服务
stop.bat

# 等待几秒

# 启动新服务
start.bat
```

**方法3: 手动停止并重启**
```cmd
# 1. 找到Java进程
tasklist | findstr java

# 2. 结束进程（使用上面找到的PID）
taskkill /F /PID <进程ID>

# 3. 重新启动
cd backend
mvn spring-boot:run
```

## 🔧 常见问题解决

### 问题1: 数据库连接失败

**错误信息**:
```
Communications link failure
The last packet sent successfully to the server was 0 milliseconds ago
```

**解决方法**:
1. 确认MySQL服务正在运行
   ```cmd
   # Windows服务管理
   services.msc
   # 找到MySQL服务，确保状态为"正在运行"
   ```

2. 检查数据库配置
   - 确认端口号（默认3306）
   - 确认用户名密码
   - 确认数据库名称

### 问题2: 字段不存在错误

**错误信息**:
```
Unknown column 'HD_XF' in 'field list'
```

**解决方法**:
1. 检查数据库表结构
   ```sql
   DESC t_zyhd;
   ```

2. 确认字段名称是否正确
3. 如果字段不存在，需要添加字段：
   ```sql
   ALTER TABLE t_zyhd ADD COLUMN HD_XF DECIMAL(3,1) DEFAULT 0 COMMENT '活动学分';
   ```

### 问题3: 端口被占用

**错误信息**:
```
Port 8080 is already in use
```

**解决方法**:
```cmd
# 1. 找到占用8080端口的进程
netstat -ano | findstr :8080

# 2. 结束该进程
taskkill /F /PID <进程ID>

# 3. 重新启动后端服务
```

### 问题4: 修改数据库后服务无法启动

**可能原因**:
- 修改了表结构但代码未更新
- SQL语法错误
- 数据类型不匹配

**解决方法**:
1. 查看后端日志中的具体错误信息
2. 检查最近修改的SQL语句
3. 确保代码中的字段映射与数据库一致

## ✅ 验证服务是否正常

### 方法1: 浏览器测试
访问: `http://localhost:8080/api/dashboard/activities`

**预期结果**: 返回JSON格式的活动列表

### 方法2: 查看日志
后端控制台应该显示:
```
Started VolunteerApplication in X.XXX seconds (JVM running for X.XXX)
```

### 方法3: 前端测试
1. 打开前端页面 `http://localhost:5173`
2. 打开浏览器开发者工具 (F12)
3. 切换到 Network 标签
4. 尝试登录
5. 查看请求是否成功

## 📞 如果问题仍未解决

请提供以下信息：

1. **后端日志**: 完整的错误堆栈信息
2. **数据库状态**: 
   ```sql
   SHOW DATABASES;
   USE universityta;
   SHOW TABLES;
   ```
3. **端口占用情况**: `netstat -ano | findstr :8080`
4. **最近的数据库修改**: 您执行了哪些SQL语句？

---

**最后更新**: 2025-12-14